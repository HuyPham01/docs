# PHP Deserialization 1

# Thử thách về lỗi bảo mật liên quan đến quá trình Serialize và Deserialize

# Mục tiêu: Chiến thắng boss ở map 2
Lỗ hổng bảo mật nghiêm trọng: Deserialization không an toàn (Insecure Deserialization).  
Lỗ hổng chính nằm ở file `/workspace/data/php/pokemon/pokemon/src/backend/save-load.php`. Cụ thể là ở chức năng "load" game, nơi bạn sử dụng hàm `unserialize()` trên dữ liệu do người dùng tải lên.
```php
// /workspace/data/php/pokemon/pokemon/src/backend/save-load.php:31
$trainer = @unserialize($data); 
```
Việc sử dụng `unserialize()` trên dữ liệu không đáng tin cậy là cực kỳ nguy hiểm. Kẻ tấn công có thể tạo ra một chuỗi (payload) đặc biệt, khi được unserialize, sẽ tạo ra các đối tượng bất kỳ trong phạm vi của ứng dụng. Điều này có thể dẫn đến việc thực thi mã tùy ý, thay đổi logic của ứng dụng, hoặc các hành vi không mong muốn khác.
```php
O:7:"Trainer":2:{s:4:"name";s:4:"test";s:7:"pokemon";O:7:"Pokemon":5:{s:6:"health";i:85;s:6:"damage";i:25;s:4:"name";s:4:"Pika";s:4:"type";s:4:"Elec";s:2:"xp";i:0;}}
```
Đoạn mã trên là một ví dụ về payload mà bạn có thể sử dụng để unserialize. Nó tạo ra một đối tượng `Trainer` với tên là "test" và một đối tượng `Pokemon` với các thuộc tính cụ thể. Bạn có thể thay đổi các giá trị như `damage` hay `health` giúp có một con Pokemon siêu mạnh.
--> done LV1

# PHP Deserialization 2

# Thử thách về lỗi bảo mật liên quan đến quá trình Serialize và Deserialize

# Mục tiêu: Chiến thắng boss ở map 3
Kịch bản tấn công cụ thể  
Trong ứng dụng của bạn, kẻ tấn công có thể khai thác lỗ hổng này bằng cách sử dụng class TrumCuoi được định nghĩa trong `/workspace/data/php/pokemon/pokemon/src/backend/libs/trainer.php`.

- Người chơi lưu game và nhận được file `pokemon.sav`. File này chứa đối tượng `Trainer` đã được serialize.
- Kẻ tấn công sửa nội dung file `pokemon.sav`, thay đổi tên class từ `Trainer` thành `TrumCuoi`.
- Kẻ tấn công tải file `pokemon.sav` đã bị sửa đổi lên thông qua chức năng "load".
- Hàm `unserialize()` sẽ tạo ra một đối tượng `TrumCuoi` và lưu vào `$_SESSION["trainer"]`.
- Giờ đây, `"trainer"` của người chơi là một `TrumCuoi`. Khi chiến đấu với bất kỳ Pokemon nào (kể cả boss), phương thức fight() của `TrumCuoi` sẽ được gọi, giúp hạ gục đối thủ ngay lập tức (return Array(Array(1, 0));). Điều này cho phép người chơi chiến thắng mọi trận đấu một cách gian lận và lấy được các "flag" một cách dễ dàng.

- Chỉnh sửa file save game (Tấn công)
- Kẻ tấn công mở file `pokemon.sav` bằng một trình soạn thảo văn bản.
- Họ sẽ thay đổi tên class từ `Trainer` thành `TrumCuoi`.
Quan trọng: Vì chuỗi `serialize` chứa độ dài của tên class, họ cũng phải cập nhật độ dài đó. "Trainer" có 7 ký tự, "TrumCuoi" có 8 ký tự.
Chuỗi sẽ được sửa từ: `O:7:"Trainer":...`
Thành: `O:8:"TrumCuoi":...`
File `pokemon.sav` sau khi sửa sẽ có nội dung
```php
O:8:"TrumCuoi":2:{s:4:"name";s:4:"test";s:7:"pokemon";O:7:"Pokemon":5:{s:6:"health";i:85;s:6:"damage";i:25;s:4:"name";s:4:"Pika";s:4:"type";s:4:"Elec";s:2:"xp";i:0;}}
```
- Kẻ tấn công tải file `pokemon.sav` đã sửa lên thông qua chức năng "load".
- Hàm `unserialize()` sẽ tạo ra một đối tượng `TrumCuoi` và lưu vào `$_SESSION["trainer"]`.
- Giờ đây, `"trainer"` của người chơi là một `TrumCuoi`. Khi chiến đấu với bất kỳ Pokemon nào (kể cả boss), phương thức `fight()` của `TrumCuoi` sẽ được gọi.
