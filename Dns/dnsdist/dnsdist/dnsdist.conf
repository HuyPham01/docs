-- Global settings
setSecurityPollSuffix("")
webserver("0.0.0.0:8083")
setWebserverConfig({acl="0.0.0.0/0"})
controlSocket('127.0.0.1:5199')
setKey("2ux3QDmpdDAzYjspjkhjkuyF8jXFU5qhd/BqXV8ag=")
setLocal('0.0.0.0:53')
setACL({'0.0.0.0/0', '::/0'})

---

-- Logging and Caching
addAction(AllRule(), LogAction("/var/log/dnsdist.log", false, true, false, true))
local pc = newPacketCache(1000000, {
    maxTTL=300, 
    minTTL=0, 
    staleTTL=60, 
    dontAge=false
})
getPool(""):setCache(pc)

---

-- Upstream Servers and Load Balancing

-- 1. Pool 'pdns' (Primary DNS - Default Pool)
newServer({
    address="172.21.0.4",  -- Server PDNS 1 (IP cũ của nsmaster)
    name="pdns-master",
    pool="pdns", 
    weight=1,             -- Cân bằng tải: 1/2 tải trong pool 'pdns'
    tcpFastOpen=true, 
    healthCheckMode='lazy', 
    checkInterval=1, 
    lazyHealthCheckFailedInterval=30, 
    rise=2, 
    maxCheckFailures=3, 
    lazyHealthCheckThreshold=30, 
    lazyHealthCheckSampleSize=100, 
    lazyHealthCheckMinSampleCount=10, 
    lazyHealthCheckMode='TimeoutOnly'
})
newServer({
    address="172.21.0.4",  -- Server PDNS 2 (IP mới)
    name="pdns-slave",
    pool="pdns", 
    weight=1,             -- Cân bằng tải: 1/2 tải trong pool 'pdns'
    tcpFastOpen=true, 
    healthCheckMode='lazy', 
    checkInterval=1, 
    lazyHealthCheckFailedInterval=30, 
    rise=2, 
    maxCheckFailures=3, 
    lazyHealthCheckThreshold=30, 
    lazyHealthCheckSampleSize=100, 
    lazyHealthCheckMinSampleCount=10, 
    lazyHealthCheckMode='TimeoutOnly'
})

-- 2. Pool 'gdns' (Google DNS - Specific Traffic Pool)
newServer({
    address="8.8.8.8",     -- Server GDNS 1 (IP cũ của ns-slave)
    name="gdns-primary",
    pool="gdns", 
    weight=1,             -- Cân bằng tải: 1/2 tải trong pool 'gdns'
    tcpFastOpen=true, 
    healthCheckMode='lazy', 
    checkInterval=1, 
    lazyHealthCheckFailedInterval=30, 
    rise=2, 
    maxCheckFailures=3, 
    lazyHealthCheckThreshold=30, 
    lazyHealthCheckSampleSize=100, 
    lazyHealthCheckMinSampleCount=10, 
    lazyHealthCheckMode='TimeoutOnly'
})
newServer({
    address="8.8.4.4",     -- Server GDNS 2 (IP mới)
    name="gdns-secondary",
    pool="gdns", 
    weight=1,             -- Cân bằng tải: 1/2 tải trong pool 'gdns'
    tcpFastOpen=true, 
    healthCheckMode='lazy', 
    checkInterval=1, 
    lazyHealthCheckFailedInterval=30, 
    rise=2, 
    maxCheckFailures=3, 
    lazyHealthCheckThreshold=30, 
    lazyHealthCheckSampleSize=100, 
    lazyHealthCheckMinSampleCount=10, 
    lazyHealthCheckMode='TimeoutOnly'
})

-- Set load balancing policy (áp dụng cho các server trong cùng 1 pool)
setServerPolicy(wrandom) 

---

-- Rate Limiting (Dynamic Block Rules)
addAction(QTypeRule(DNSQType.ANY), TCAction())
local dbr = dynBlockRulesGroup()
dbr:setQueryRate(30, 10, "Exceeded query rate", 60)
dbr:setRCodeRate(DNSRCode.NXDOMAIN, 20, 10, "Exceeded NXD rate", 60)
dbr:setRCodeRate(DNSRCode.SERVFAIL, 20, 10, "Exceeded ServFail rate", 60)
dbr:setQTypeRate(DNSQType.ANY, 5, 10, "Exceeded ANY rate", 60)
dbr:setQTypeRate(DNSQType.A, 5, 10, "Exceeded A rate", 60)
dbr:setResponseByteRate(10000, 10, "Exceeded resp BW rate", 60)
function maintenance()
    dbr:apply()
end

---

-- Zone Transfers (Notify Handling)
function flushCache(dq)
    errlog("Got notify for " .. dq.qname:toString())
    local cache = getPool(""):getCache()
    if cache then
        local before = cache:toString()
        cache:expungeByName(dq.qname, DNSQType.ANY, true)
        local after = cache:toString()
        errlog("Cache size: from " .. before .. " to " .. after)
    end
    return DNSAction.None
end
addAction(OpcodeRule(DNSOpcode.Notify), TeeAction("172.21.0.4"))
addAction(OpcodeRule(DNSOpcode.Notify), TeeAction("8.8.8.8"))
addResponseAction(AndRule({OpcodeRule(DNSOpcode.Notify), RCodeRule(DNSRCode.NOERROR)}), LuaResponseAction(flushCache))

---

-- Routing Rules

-- 1. Ưu tiên: Match traffic cho googleapis.com vào pool 'gdns'
addAction(RegexRule(".*\\.googleapis\\.com$"), PoolAction("gdns"))

-- 2. Ưu tiên: Match traffic cho google.com (chính xác) vào pool 'gdns'
addAction(QNameRule("google.com"), PoolAction("gdns"))

-- 3. Mặc định: Toàn bộ traffic còn lại (bao gồm tất cả các domain khác) vào pool 'pdns'
addAction(AllRule(), PoolAction("pdns"))